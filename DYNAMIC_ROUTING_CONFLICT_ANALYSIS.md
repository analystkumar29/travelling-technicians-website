# üö® DYNAMIC ROUTING CONFLICT ANALYSIS

## CRITICAL ISSUE IDENTIFIED

You have **TWO competing dynamic page generation systems** that are causing routing conflicts and pricing inconsistencies.

---

## System 1: Legacy Dynamic Routing (ACTIVE)
**Location**: `src/pages/repair/[city]/[service]/[model].tsx`

**How it works:**
```
Request: /repair/vancouver/screen-repair/pixel-6a
         ‚Üì
getStaticPaths(): Generates paths from database query
         ‚Üì
getStaticProps(): Calls getDynamicPricing() API function
         ‚Üì
Displays pricing from getDynamicPricing()
```

**Key Characteristics:**
- Uses traditional Next.js dynamic routing `[city]/[service]/[model]`
- Has `serviceSlugMapping` to convert database slugs:
  - `screen-replacement-mobile` ‚Üí `screen-repair`
  - `battery-replacement-mobile` ‚Üí `battery-replacement`
  - etc.
- Fetches pricing from `getDynamicPricing()` function
- Has hardcoded phone: `(778) 389-9251`
- Uses fallback pricing if API fails
- Generates all combinations at build time

**Database Query Path:**
```
getAllActiveCities() ‚Üí getAllActiveServices() ‚Üí getModelsForService()
‚Üì
getDynamicPricing(citySlug, serviceSlug, modelSlug)
‚Üì
Returns: {basePrice, discountedPrice, priceRange}
```

---

## System 2: Universal Dynamic Routing (NEW)
**Location**: `src/pages/repair/[[...slug]].tsx`

**How it works:**
```
Request: /repair/vancouver/screen-replacement-mobile/pixel-6a
         ‚Üì
getStaticPaths(): Fetches from dynamic_routes table
         ‚Üì
getStaticProps(): Reads payload from dynamic_routes
         ‚Üì
Displays pricing from payload.standard_pricing + premium_pricing
```

**Key Characteristics:**
- Uses catch-all routing `[[...slug]]`
- Fetches pre-computed data from `dynamic_routes` table
- Includes `standard_pricing` and `premium_pricing` in payload
- No serviceSlugMapping - uses slugs directly
- Uses payload data (no API call to getDynamicPricing)
- Uses dynamic phone from city data: `city.local_phone`
- Payload has psychological pricing built-in

**Database Query Path:**
```
view_active_repair_routes
‚Üì
dynamic_routes table (with pre-computed payload)
‚Üì
Includes: {standard_pricing, premium_pricing, city, service, model, etc.}
```

---

## THE CONFLICT: Route Matching Priority

When a request comes for `/repair/vancouver/screen-replacement-mobile/pixel-6a`:

### Next.js Route Priority:
1. **Specific routes** (`[city]/[service]/[model].tsx`) match FIRST
2. **Catch-all routes** (`[[...slug]].tsx`) match SECOND (if specific doesn't match)

### What Actually Happens:
‚úÖ **Legacy system matches first** because `[city]/[service]/[model]` is more specific than `[[...slug]]`

### Result:
- `/repair/vancouver/screen-replacement-mobile/pixel-6a` hits the **legacy system**
- `/repair/vancouver/screen-replacement-mobile/pixel-6a` gets pricing from `getDynamicPricing()`
- Universal system NEVER gets called for this URL
- You're getting different pricing data!

---

## Why Pricing Data is Different

### Legacy System (Currently Used):
```typescript
// From src/pages/repair/[city]/[service]/[model].tsx
const pricingData = {
  basePrice: dynamicPricing.basePrice,        // From getDynamicPricing()
  discountedPrice: dynamicPricing.discountedPrice,
  priceRange: dynamicPricing.priceRange
};
```

### Universal System (Not Used):
```typescript
// From src/pages/repair/[[...slug]].tsx
const pricing = {
  compareAtPrice: standardPricing.compare_at_price,
  basePrice: standardPricing.base_price,
  premiumPrice: premiumPricing.base_price,
  savings: differences,
  priceRange: "...",
};
```

---

## Service Slug Mismatch

### Legacy System:
```typescript
const serviceSlugMapping: Record<string, string> = {
  'screen-replacement-mobile': 'screen-repair',
  'screen-replacement-laptop': 'laptop-screen-repair',
  'battery-replacement-mobile': 'battery-replacement',
  'battery-replacement-laptop': 'battery-replacement'
};
```

### Universal System:
- No mapping - uses slugs directly from `dynamic_routes`
- expects: `screen-replacement-mobile`
- But URL has: `screen-repair`

This means:
- `/repair/vancouver/screen-repair/pixel-6a` ‚Üí Legacy system handles it
- `/repair/vancouver/screen-replacement-mobile/pixel-6a` ‚Üí Could go either way

---

## The Link Mismatch Problem

### Links Generated by Sites:
- Booking form links: `/repair/vancouver/screen-repair/pixel-6a` 
- Sitemap: Mix of both formats
- Search results: Could have both URLs

### Result:
- Same content appears at multiple URLs
- Google sees duplicate content
- SEO confusion
- Pricing inconsistencies

---

## Data Fetching Contradiction

| Aspect | Legacy System | Universal System |
|--------|--------------|-----------------|
| Data Source | `getDynamicPricing()` function call | `dynamic_routes.payload` (pre-computed) |
| Pricing Data | Fetched at request time | Computed at build time |
| Service Slug | Mapped via `serviceSlugMapping` | Direct from database |
| Phone Number | Hardcoded `(778) 389-9251` | From `city.local_phone` |
| Tiers | Single pricing | Standard + Premium tiers |
| Psychological Pricing | ‚ùå Not implemented | ‚úÖ Implemented |

---

## PROBLEMS CAUSED BY CONFLICT

### 1. **Duplicate Content**
- Same page at: `/screen-repair/` AND `/screen-replacement-mobile/`
- Google penalty risk
- Lower search rankings

### 2. **Pricing Inconsistency**
- Dynamic page shows one price
- Booking form might show another
- Customer confusion

### 3. **Phone Number Inconsistency**
- Legacy: Hardcoded `(778) 389-9251`
- Universal: From `city.local_phone` field
- Wrong customer directed somewhere

### 4. **Psychological Pricing Not Applied**
- New psychological pricing only in universal system
- Legacy system shows old pricing logic
- Conversion rate impact

### 5. **Routing Confusion**
- Which links to generate in sitemap?
- Which service slugs to use?
- Build time increases (generating both systems)

---

## SOLUTION REQUIRED

**Option 1: Keep Universal, Delete Legacy** (RECOMMENDED)
- Delete `src/pages/repair/[city]/[service]/[model].tsx`
- Let `[[...slug]]` handle all routes
- Update all links to use `screen-replacement-mobile` (not `screen-repair`)
- Implement 301 redirects from old URLs to new URLs

**Option 2: Keep Legacy, Delete Universal**
- Delete `src/pages/repair/[[...slug]].tsx`
- Keep existing legacy system
- Update legacy to implement psychological pricing
- Update `getDynamicPricing()` to return standard/premium tiers

**Option 3: Merge Systems**
- Have `[[...slug]]` detect and redirect to legacy system
- Centralize pricing data source
- Decide on single URL format

---

## RECOMMENDATION

**Go with Option 1: Universal System**

Reasons:
1. ‚úÖ Already implements psychological pricing
2. ‚úÖ Pre-computed payload = better performance
3. ‚úÖ Eliminates API call to `getDynamicPricing()`
4. ‚úÖ Unified route format in database
5. ‚úÖ Easier to manage tiers

**Steps:**
1. Confirm universal system has correct pricing data
2. Set up 301 redirects from `/screen-repair/*` to `/screen-replacement-mobile/*`
3. Update sitemap generation to use universal routes
4. Delete legacy `[city]/[service]/[model].tsx`
5. Clear all caches
6. Monitor for 404s and redirect them

---

## VERIFICATION CHECKLIST

- [ ] Confirm which system is currently being used for each URL
- [ ] Check `getDynamicPricing()` implementation
- [ ] Verify `dynamic_routes.payload` has all required fields
- [ ] Test that universal system returns correct pricing
- [ ] Verify psychological pricing displays correctly
- [ ] Check all internal links point to correct URLs
- [ ] Set up 301 redirects for legacy URLs
- [ ] Update sitemap to use correct slugs
- [ ] Delete legacy route file
- [ ] Test booking form with new URLs
- [ ] Monitor analytics for traffic drops

---

**Status**: ‚ö†Ô∏è CONFLICT DETECTED - Requires Remediation
**Impact**: Medium (affects pricing display, SEO, customer journey)
**Severity**: High (creates duplicate content)
